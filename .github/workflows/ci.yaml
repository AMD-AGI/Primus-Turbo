name: Primus-Turbo-CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:

env:
  UCCL_WHEEL_DIR: /apps/tas/0_public/primus_turbo_k8s_ci/uccl-wheel

jobs:
  code-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - name: Print job info
        run: |
          echo "ðŸŽ‰ Begin Primus-Turbo Python Lint."
          echo "ðŸ§ Running on ${{ runner.os }}, branch: ${{ github.ref }}"
      - uses: actions/checkout@v4
      - run: git config --global --add safe.directory /github/workspace
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
            python-version: ${{ matrix.python-version }}
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Install Autoflake
        run: pip install autoflake==v2.3.1
      - name: Run Autoflake
        if: always()
        run: |
          output=$(autoflake . --remove-all-unused-imports --remove-unused-variables --expand-star-imports --ignore-init-module-imports --recursive)
          if [[ -n $output ]]
          then
            echo "Autoflake check failed: $output"
            exit 1
          else
            echo "Autoflake check success."
            exit 0
          fi
      - uses: isort/isort-action@v1
        if: always()
        with:
            configuration: "--profile black --check-only --diff"
      - uses: psf/black@24.8.0
        if: always()
        with:
          options: "--check --diff --color --verbose --line-length=110"

  install-dependencies:
    runs-on: turbo-pt-gfx942-2510-279fq
    env:
        UCCL_COMMIT: 94f0e20716966a33b1045ded9cdc5f9ad3bb36ab #  [EP] Debug AMD performance and mem consistency issues (#600)
        UCCL_PY_VER: 3.12
    steps:
      - name: Print job info
        run: |
          echo "ðŸŽ‰ Begin Primus-Turbo Install Dependencies."
          echo "ðŸ§ Running on ${{ runner.os }}, branch: ${{ github.ref }}"

      - name: Checkout UCCL
        uses: actions/checkout@v4
        with:
          repository: uccl-project/uccl
          ref: ${UCCL_COMMIT}
          fetch-depth: 0
          path: uccl

      - name: Build UCCL
        run: |
          mv uccl /tmp/uccl
          cd /tmp/uccl
          git config --global --add safe.directory /tmp/uccl

          start_time=$(date +%s)
          echo "âœ… [build uccl] started at: $(date)"

          sed -i '/pip install.*--pre torch torchvision.*\\$/,+1d' docker/Dockerfile.rocm

          # build wheel
          bash build.sh rocm ep ${UCCL_PY_VER}

          cd ep/deep_ep_wrapper
          python3 setup.py bdist_wheel
          cp dist/*.whl /tmp/uccl/wheelhouse-rocm/

          end_time=$(date +%s)
          elapsed=$((end_time - start_time))
          echo "âœ… [build uccl] ended at: $(date)"
          echo "â±ï¸ [build uccl] Total elapsed time: ${elapsed} seconds"

      - name: Copy wheel to shared storage
        run: |
          mkdir -p ${{ env.UCCL_WHEEL_DIR }}
          cp -v /tmp/uccl/wheelhouse-rocm/*.whl ${{ env.UCCL_WHEEL_DIR }}/
          echo "ðŸ“¦ Wheel files copied to: ${{ env.UCCL_WHEEL_DIR }}"
          ls -la ${{ env.UCCL_WHEEL_DIR }}/

  unittest-pytorch-gfx942:
    needs:[code-lint, install-dependencies]
    runs-on: turbo-pt-gfx942-2510-279fq
    env:
      PRIMUS_TURBO_WORKDIR: /apps/tas/0_public/primus_turbo_k8s_ci/pytorch
    steps:
      - run: echo "ðŸŽ‰ Begin Primus-Turbo PyTorch Framework Unit Test."
      - name: Change owner
        run: |
          echo "change the owner of all primus-turbo files, as some files are generated by root"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          sudo chown -R $(id -u):$(id -g) ${GITHUB_WORKSPACE}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Print dir
        run: |
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "current dir: $(pwd)"
      - name: Set ut log path
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/latest" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME=${{ github.ref }}  # refs/tags/v1.0.0
            TAG="${TAG_NAME#refs/tags/}" # v1.0.0
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/$TAG" >> $GITHUB_ENV
          else
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/others" >> $GITHUB_ENV
          fi
      - name: Print rocminfo
        run: |
          echo "=== rocminfo ==="
          rocminfo || true
      - name: Install and build
        run: |
          echo "set UT_LOG_PATH as: ${{ env.UT_LOG_PATH }}"
          if [ -d "${{ env.UT_LOG_PATH }}" ]; then
            echo "UT_LOG_PATH dir exists. Deleting..."
            rm -rf "${{ env.UT_LOG_PATH }}"
          fi
          unset AITER_ASM_DIR
          pip3 uninstall -y aiter || true
          pip3 install -r requirements.txt
          GPU_ARCHS="gfx942;gfx950" PRIMUS_TURBO_FRAMEWORK="PYTORCH" pip3 install --no-build-isolation -e . -v

          # ===== Install UCCL wheel =====
          echo "==> Installing UCCL from pre-built wheel..."
          echo "Wheel directory: ${{ env.UCCL_WHEEL_DIR }}"
          ls -la "${{ env.UCCL_WHEEL_DIR }}/"
          pip3 install "${{ env.UCCL_WHEEL_DIR }}"/*.whl

          echo "==> UCCL installation completed successfully!"
      - name: Run single-GPU tests (parallel)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 95
          max_attempts: 2
          # use timeout to terminate pytest and its workers on timeout
          command: >
            timeout -k 60s 90m
            bash -lc
            "exec pytest -v tests/pytorch -n 8 --log-cli-level=INFO"
        env:
          XLA_PYTHON_CLIENT_PREALLOCATE: "false"
      - name: Run distributed tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 60
          max_attempts: 2
          command: pytest -v tests/pytorch --dist-only --log-cli-level=INFO
        env:
          XLA_PYTHON_CLIENT_PREALLOCATE: "false"

  unittest-jax-gfx942:
    needs: code-lint
    runs-on: turbo-jax-gfx942-259-f8qds
    env:
      PRIMUS_TURBO_WORKDIR: /apps/tas/0_public/primus_turbo_k8s_ci/jax
    steps:
      - run: echo "ðŸŽ‰ Begin Primus-Turbo JAX Framework Unit-Test."
      - name: Change owner
        run: |
          echo "change the owner of all primus-turbo files, as some files are generated by root"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          sudo chown -R $(id -u):$(id -g) ${GITHUB_WORKSPACE}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Print dir
        run: |
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "current dir: $(pwd)"
      - name: Set ut log path
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/latest" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME=${{ github.ref }}  # refs/tags/v1.0.0
            TAG="${TAG_NAME#refs/tags/}" # v1.0.0
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/$TAG" >> $GITHUB_ENV
          else
            echo "UT_LOG_PATH=${PRIMUS_TURBO_WORKDIR}/ut_out/others" >> $GITHUB_ENV
          fi
      - name: Print rocminfo
        run: |
          echo "=== rocminfo ==="
          rocminfo || true
      - name: Install and build
        run: |
          echo "set UT_LOG_PATH as: ${{ env.UT_LOG_PATH }}"
          if [ -d "${{ env.UT_LOG_PATH }}" ]; then
            echo "UT_LOG_PATH dir exists. Deleting..."
            rm -rf "${{ env.UT_LOG_PATH }}"
          fi
          unset AITER_ASM_DIR
          pip3 install -r requirements.txt
          GPU_ARCHS="gfx942;gfx950" PRIMUS_TURBO_FRAMEWORK="JAX" pip3 install --no-build-isolation -e . -v
      - name: Run single-GPU tests (parallel)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 60
          max_attempts: 2
          command: pytest -v tests/jax -n 8 --log-cli-level=INFO
        env:
          XLA_PYTHON_CLIENT_PREALLOCATE: "false"
      - name: Run distributed tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 2
          command: pytest -v tests/jax --dist-only --log-cli-level=INFO
        env:
          XLA_PYTHON_CLIENT_PREALLOCATE: "false"
