name: Primus-Turbo-Benchmark

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  benchmark-pytorch-gfx942:
    runs-on: turbo-pt-bench-gfx942-259-lrv82
    steps:
      - run: echo "ðŸŽ‰ Begin Primus-Turbo Benchmark."
      - name: Change owner
        run: |
          echo "change the owner of all primus-turbo files, as some files are generated by root"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          sudo chown -R $(id -u):$(id -g) ${GITHUB_WORKSPACE}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: 'recursive'
      - name: Print dir
        run: |
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "current dir: $(pwd)"
      - name: Install Primus-Turbo
        run: |
          unset AITER_ASM_DIR
          pip3 install -r requirements.txt
          GPU_ARCHS="gfx942" PRIMUS_TURBO_FRAMEWORK="PYTORCH" pip3 install --no-build-isolation -e . -v
      - name: Run GEMM Benchmark
        continue-on-error: true
        run: |
          PYTHONPATH=. python3 benchmark/ops/bench_gemm.py
      # - name: Run Grouped GEMM Benchmark
      #   run: |
      #     python benchmark/ops/bench_grouped_gemm.py
      # - name: Run Attention Benchmark
      #   run: |
      #     python benchmark/ops/bench_attention.py
